<div *ngIf="currentLesson && currentStep; else loading" class="space-y-6">
  <!-- Lesson header -->
  <div class="flex items-center justify-between">
    <div>
      <a routerLink="/dashboard" class="inline-flex items-center text-blue-600 hover:text-blue-700 mb-2">
        <i-feather name="chevron-left" class="h-4 w-4 mr-1"></i-feather>
        Back to Dashboard
      </a>
      <h1 class="text-2xl font-bold text-gray-900">{{ currentLesson.title }}</h1>
    </div>
    <div class="flex items-center space-x-4">
      <div class="flex items-center text-gray-500">
        <i-feather name="clock" class="h-4 w-4 mr-1"></i-feather>
        <span class="text-sm">{{ currentLesson.duration }} min</span>
      </div>
      <div class="flex items-center text-gray-500">
        <i-feather name="bar-chart" class="h-4 w-4 mr-1"></i-feather>
        <span class="text-sm">{{ currentLesson.points }} XP</span>
      </div>
      <app-badge [variant]="currentLesson.difficulty === 'beginner' ? 'success' : currentLesson.difficulty === 'intermediate' ? 'warning' : 'danger'">
        {{ currentLesson.difficulty.charAt(0).toUpperCase() + currentLesson.difficulty.slice(1) }}
      </app-badge>
    </div>
  </div>

  <!-- Progress bar -->
  <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
    <div class="flex justify-between items-center mb-2">
      <span class="text-sm font-medium text-gray-700">Step {{ currentStepIndex + 1 }} of {{ currentLesson.steps.length }}</span>
      <span class="text-sm text-gray-500">{{ progressPercentage | number:'1.0-0' }}% Complete</span>
    </div>
    <app-progress-bar [value]="progressPercentage" [showValue]="false" color="blue"></app-progress-bar>
  </div>

  <!-- Lesson content -->
  <app-card>
    <app-card-content class="p-6">
      <ng-container [ngSwitch]="currentStep.type">
        
        <!-- CORRECTED PART: Separate ng-container for each case -->
        <ng-container *ngSwitchCase="'introduction'">
          <div class="space-y-4">
            <h3 class="text-xl font-semibold text-gray-900">{{ currentStep.title }}</h3>
            <p class="text-gray-700 leading-relaxed">{{ currentStep.content }}</p>
            <div *ngIf="currentStep.media" class="mt-6">
              <img *ngIf="currentStep.media.type === 'image'" [src]="currentStep.media.url" [alt]="currentStep.title" class="rounded-lg w-full max-w-2xl mx-auto" />
              <div *ngIf="currentStep.media.type === 'video'" class="aspect-video bg-gray-100 rounded-lg flex items-center justify-center">
                <p class="text-gray-500">Video content would play here</p>
              </div>
            </div>
            <div class="pt-4">
              <app-button variant="primary" (click)="goToNextStep()">
                <i-feather name="chevron-right" class="h-4 w-4 mr-2"></i-feather>
                Continue
              </app-button>
            </div>
          </div>
        </ng-container>
        <ng-container *ngSwitchCase="'content'">
          <div class="space-y-4">
            <h3 class="text-xl font-semibold text-gray-900">{{ currentStep.title }}</h3>
            <p class="text-gray-700 leading-relaxed">{{ currentStep.content }}</p>
            <div *ngIf="currentStep.media" class="mt-6">
              <img *ngIf="currentStep.media.type === 'image'" [src]="currentStep.media.url" [alt]="currentStep.title" class="rounded-lg w-full max-w-2xl mx-auto" />
              <div *ngIf="currentStep.media.type === 'video'" class="aspect-video bg-gray-100 rounded-lg flex items-center justify-center">
                <p class="text-gray-500">Video content would play here</p>
              </div>
            </div>
            <div class="pt-4">
              <app-button variant="primary" (click)="goToNextStep()">
                <i-feather name="chevron-right" class="h-4 w-4 mr-2"></i-feather>
                Continue
              </app-button>
            </div>
          </div>
        </ng-container>
        <ng-container *ngSwitchCase="'summary'">
          <div class="space-y-4">
            <h3 class="text-xl font-semibold text-gray-900">{{ currentStep.title }}</h3>
            <p class="text-gray-700 leading-relaxed">{{ currentStep.content }}</p>
            <div *ngIf="currentStep.media" class="mt-6">
              <img *ngIf="currentStep.media.type === 'image'" [src]="currentStep.media.url" [alt]="currentStep.title" class="rounded-lg w-full max-w-2xl mx-auto" />
              <div *ngIf="currentStep.media.type === 'video'" class="aspect-video bg-gray-100 rounded-lg flex items-center justify-center">
                <p class="text-gray-500">Video content would play here</p>
              </div>
            </div>
            <div class="pt-4">
              <app-button variant="primary" (click)="goToNextStep()">
                <i-feather name="chevron-right" class="h-4 w-4 mr-2"></i-feather>
                Continue
              </app-button>
            </div>
          </div>
        </ng-container>

        <!-- Quiz Step -->
        <ng-container *ngSwitchCase="'quiz'">
          <div class="space-y-4">
            <h3 class="text-xl font-semibold text-gray-900">{{ currentStep.title }}</h3>
            <p class="text-gray-700 mb-6">{{ currentStep.content }}</p>
            <div *ngIf="currentStep.options && currentStep.options.length > 0" class="space-y-3 mt-4">
              <p class="font-medium text-gray-800">{{ currentStep.options[0] }}</p>
              <div *ngFor="let option of currentStep.options.slice(1)" class="relative">
                <button
                  (click)="handleQuizAnswer(option)"
                  [disabled]="quizSubmitted"
                  class="w-full p-3 text-left border rounded-lg transition-colors"
                  [ngClass]="{
                    'bg-blue-50 border-blue-500 text-blue-700': userAnswers[currentStep.id] === option,
                    'border-gray-300 hover:bg-gray-50': userAnswers[currentStep.id] !== option,
                    'bg-green-50 border-green-500': quizSubmitted && currentStep.correctAnswer === option,
                    'bg-red-50 border-red-500': quizSubmitted && userAnswers[currentStep.id] === option && userAnswers[currentStep.id] !== currentStep.correctAnswer
                  }"
                >
                  {{ option }}
                  <i-feather *ngIf="quizSubmitted && currentStep.correctAnswer === option" name="check-circle" class="absolute right-3 top-3 h-5 w-5 text-green-500"></i-feather>
                </button>
              </div>
            </div>
            <div *ngIf="quizSubmitted" class="p-4 rounded-lg" [ngClass]="quizResult === 'correct' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'">
              <p class="font-medium">
                {{ quizResult === 'correct' ? 'Correct! Well done.' : 'Incorrect. The correct answer is: ' + currentStep.correctAnswer }}
              </p>
            </div>
            <div class="pt-4 flex justify-between">
              <app-button variant="outline" (click)="goToPreviousStep()" [disabled]="currentStepIndex === 0">
                <i-feather name="chevron-left" class="h-4 w-4 mr-2"></i-feather>
                Back
              </app-button>
              <app-button *ngIf="!quizSubmitted" variant="primary" (click)="submitQuiz()" [disabled]="!userAnswers[currentStep.id]">Submit Answer</app-button>
              <app-button *ngIf="quizSubmitted" variant="primary" (click)="goToNextStep()">
                <i-feather name="chevron-right" class="h-4 w-4 mr-2"></i-feather>
                Continue
              </app-button>
            </div>
          </div>
        </ng-container>

        <!-- CORRECTED PART: Separate ng-container for each case -->
        <ng-container *ngSwitchCase="'exercise'">
          <div class="space-y-4">
            <h3 class="text-xl font-semibold text-gray-900">{{ currentStep.title }}</h3>
            <p class="text-gray-700 mb-4">{{ currentStep.content }}</p>
            <div *ngIf="currentStep.options" class="bg-gray-50 p-4 rounded-lg mb-4">
              <h4 class="font-medium text-gray-800 mb-2">Options:</h4>
              <ul class="list-disc pl-5 space-y-1">
                <li *ngFor="let option of currentStep.options" class="text-gray-700">{{ option }}</li>
              </ul>
            </div>
            <div class="mt-4">
              <label for="response" class="block text-sm font-medium text-gray-700 mb-1">Your response:</label>
              <textarea
                id="response"
                rows="5"
                class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Type your response here..."
                [(ngModel)]="textInput"
                [disabled]="quizSubmitted"
              ></textarea>
            </div>
            <div *ngIf="quizSubmitted" class="p-4 rounded-lg bg-blue-50 text-blue-800">
              <p class="font-medium">Response submitted!</p>
              <p class="text-sm mt-1">In a real application, you would receive personalized feedback on your response.</p>
            </div>
            <div class="pt-4 flex justify-between">
              <app-button variant="outline" (click)="goToPreviousStep()" [disabled]="currentStepIndex === 0">
                <i-feather name="chevron-left" class="h-4 w-4 mr-2"></i-feather>
                Back
              </app-button>
              <app-button *ngIf="!quizSubmitted" variant="primary" (click)="submitTextInput()" [disabled]="textInput.trim().length === 0 && !recordingComplete">Submit Response</app-button>
              <app-button *ngIf="quizSubmitted" variant="primary" (click)="goToNextStep()">
                <i-feather name="chevron-right" class="h-4 w-4 mr-2"></i-feather>
                Continue
              </app-button>
            </div>
          </div>
        </ng-container>
        <ng-container *ngSwitchCase="'practice'">
          <div class="space-y-4">
            <h3 class="text-xl font-semibold text-gray-900">{{ currentStep.title }}</h3>
            <p class="text-gray-700 mb-4">{{ currentStep.content }}</p>
            <div *ngIf="currentStep.options" class="bg-gray-50 p-4 rounded-lg mb-4">
              <h4 class="font-medium text-gray-800 mb-2">Options:</h4>
              <ul class="list-disc pl-5 space-y-1">
                <li *ngFor="let option of currentStep.options" class="text-gray-700">{{ option }}</li>
              </ul>
            </div>
            <div class="mb-4">
              <div class="flex justify-center space-x-4 mb-4">
                <ng-container *ngIf="!recordingComplete; else recordingPlayback">
                  <button (click)="isRecording ? stopRecording() : startRecording()" class="w-12 h-12 rounded-full flex items-center justify-center" [ngClass]="isRecording ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'">
                    <i-feather *ngIf="!isRecording" name="mic" class="h-6 w-6"></i-feather>
                    <i-feather *ngIf="isRecording" name="stop-circle" class="h-6 w-6"></i-feather>
                  </button>
                </ng-container>
                <ng-template #recordingPlayback>
                  <div class="flex space-x-4">
                    <button (click)="playRecording()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center">
                      <i-feather name="play" class="h-5 w-5"></i-feather>
                    </button>
                    <button (click)="startRecording()" class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                      <i-feather name="mic" class="h-5 w-5"></i-feather>
                    </button>
                  </div>
                </ng-template>
              </div>
              <p class="text-sm text-center text-gray-500">
                {{ isRecording ? 'Recording... Speak clearly' : (recordingComplete ? 'Recording complete. You can play it back or re-record.' : 'Click the microphone to start recording your response.') }}
              </p>
            </div>
            <div class="mt-4">
              <label for="response" class="block text-sm font-medium text-gray-700 mb-1">Your response:</label>
              <textarea
                id="response"
                rows="5"
                class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Type your response here..."
                [(ngModel)]="textInput"
                [disabled]="quizSubmitted"
              ></textarea>
            </div>
            <div *ngIf="quizSubmitted" class="p-4 rounded-lg bg-blue-50 text-blue-800">
              <p class="font-medium">Response submitted!</p>
              <p class="text-sm mt-1">In a real application, you would receive personalized feedback on your response.</p>
            </div>
            <div class="pt-4 flex justify-between">
              <app-button variant="outline" (click)="goToPreviousStep()" [disabled]="currentStepIndex === 0">
                <i-feather name="chevron-left" class="h-4 w-4 mr-2"></i-feather>
                Back
              </app-button>
              <app-button *ngIf="!quizSubmitted" variant="primary" (click)="submitTextInput()" [disabled]="textInput.trim().length === 0 && !recordingComplete">Submit Response</app-button>
              <app-button *ngIf="quizSubmitted" variant="primary" (click)="goToNextStep()">
                <i-feather name="chevron-right" class="h-4 w-4 mr-2"></i-feather>
                Continue
              </app-button>
            </div>
          </div>
        </ng-container>

      </ng-container>
    </app-card-content>
  </app-card>

  <!-- Help section -->
  <div class="bg-gray-50 rounded-lg p-4 flex items-start">
    <div class="bg-blue-100 rounded-full p-2 mr-3">
      <i-feather name="help-circle" class="h-5 w-5 text-blue-600"></i-feather>
    </div>
    <div>
      <h3 class="font-medium text-gray-900">Need help?</h3>
      <p class="text-sm text-gray-600">
        If you're having trouble with this lesson, you can access additional resources or contact a tutor for assistance.
      </p>
      <button class="text-sm text-blue-600 hover:text-blue-700 mt-1 inline-flex items-center">
        View resources <i-feather name="chevron-right" class="h-3 w-3 ml-1"></i-feather>
      </button>
    </div>
  </div>
</div>

<!-- Loading State -->
<ng-template #loading>
  <div class="flex items-center justify-center h-[500px]">
    <div class="text-center">
      <i-feather name="book-open" class="h-12 w-12 text-blue-500 mx-auto mb-4 animate-pulse"></i-feather>
      <h2 class="text-xl font-semibold text-gray-900">Loading lesson...</h2>
    </div>
  </div>
</ng-template>
